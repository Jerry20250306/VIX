# PROD è³‡æ–™èˆ‡ç¨‹å¼è¼¸å‡ºæ¬„ä½å°æ‡‰è¡¨

## Gamma åƒæ•¸è¨­å®š

æ ¹æ“š `step0_2_ema_calculation.py` (ç¬¬48-52è¡Œ):

```python
ALPHA = 0.95    # EMA å¹³æ»‘ä¿‚æ•¸
GAMMA_0 = 1.2   # åŸºç¤å¯¬å®¹åº¦ï¼šç•¶ Bid = 0 æ™‚ä½¿ç”¨
GAMMA_1 = 1.5   # ä¸­åƒ¹ä¸‹é™å¯¬å®¹åº¦ï¼šç•¶ Bid > 0 ä¸” Mid_t <= Q_hat_Mid_t-1 æ™‚ä½¿ç”¨  
GAMMA_2 = 2.0   # ä¸­åƒ¹ä¸Šå‡å¯¬å®¹åº¦ï¼šç•¶ Bid > 0 ä¸” Mid_t > Q_hat_Mid_t-1 æ™‚ä½¿ç”¨
LAMBDA = 15     # æœ€å¤§å…è¨±åƒ¹å·®(é»æ•¸)
```

### âš ï¸ èˆ‡ spec.md çš„å·®ç•°èªªæ˜

ç¨‹å¼å¯¦éš›ä½¿ç”¨çš„åƒæ•¸èˆ‡ spec.md è¡¨7 æœ‰æ‰€ä¸åŒ:

| åƒæ•¸ | spec.md è¨­å®šå€¼ | ç¨‹å¼å¯¦éš›å€¼ | ç”¨é€” |
|------|---------------|-----------|------|
| Î³â‚€ (GAMMA_0) | 1.20 | **1.2** | Bid = 0 (æ·±åº¦åƒ¹å¤–) |
| Î³â‚ (GAMMA_1) | 2.00 | **1.5** | ä¸­åƒ¹ä¸‹é™æˆ–æŒå¹³ |
| Î³â‚‚ (GAMMA_2) | 2.50 | **2.0** | ä¸­åƒ¹ä¸Šå‡ |
| Î» (LAMBDA) | 0.50 | **15** | æœ€å¤§å…è¨±åƒ¹å·® |

**æ³¨æ„**: ç¨‹å¼ä½¿ç”¨çš„ Î³â‚=1.5, Î³â‚‚=2.0, Î»=15 èˆ‡ PROD å¯¦éš›è¡Œç‚ºè¼ƒæ¥è¿‘,é€™è§£é‡‹äº†ç‚ºä½•é©—è­‰èƒ½é”åˆ°é«˜ä¸€è‡´æ€§ã€‚

---

## æ¬„ä½å°æ‡‰è¡¨

### ğŸ“‹ ç´¢å¼•æ¬„ä½ (Index Fields)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | è³‡æ–™é¡å‹ | èªªæ˜ | æ¯”å°æ–¹å¼ |
|---|-----------|-----------|---------|------|---------|
| 1 | `date` | `date` | å­—ä¸² | è³‡æ–™æ—¥æœŸ (YYYYMMDD) | å®Œå…¨ç›¸åŒ âœ… |
| 2 | `time` | `time` | å­—ä¸²/æ•´æ•¸ | å¿«ç…§æ™‚é–“ (HHMMSS) | PRODæ˜¯å­—ä¸²,æˆ‘å€‘æ˜¯æ•´æ•¸,éœ€è½‰æ› |
| 3 | `strike` (ç¬¬1å€‹) | `strike` | å­—ä¸²/æ•´æ•¸ | å±¥ç´„åƒ¹ | PRODæ˜¯å­—ä¸²,æˆ‘å€‘æ˜¯æ•´æ•¸,éœ€è½‰æ› |

### ğŸ¯ æœ€çµ‚å ±åƒ¹æ¬„ä½ (Final Filtered Quote - Q_hat)

é€™æ˜¯**æœ€é‡è¦çš„é©—è­‰æ¬„ä½**,ç›´æ¥å½±éŸ¿ VIX è¨ˆç®—çµæœã€‚

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | è³‡æ–™é¡å‹ | èªªæ˜ | é©—è­‰çµæœ |
|---|-----------|-----------|---------|------|---------|
| 4 | `c.bid` | `c.bid` | æ•¸å€¼ | **Call æœ€çµ‚è²·åƒ¹** | âœ… 100.00% |
| 5 | `c.ask` | `c.ask` | æ•¸å€¼ | **Call æœ€çµ‚è³£åƒ¹** | âœ… 100.00% |
| 6 | `strike` (ç¬¬2å€‹) | - | å­—ä¸² | é‡è¤‡çš„å±¥ç´„åƒ¹ | PRODé¡å¤–æ¬„ä½ |
| 7 | `p.bid` | `p.bid` | æ•¸å€¼ | **Put æœ€çµ‚è²·åƒ¹** | âœ… 100.00% |
| 8 | `p.ask` | `p.ask` | æ•¸å€¼ | **Put æœ€çµ‚è³£åƒ¹** | âœ… 100.00% |

### ğŸ“Š å ±åƒ¹ä¾†æº (Quote Source)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ | å¯èƒ½å€¼ |
|---|-----------|-----------|------|--------|
| 9 | `c.type` | `c.source` | Call å ±åƒ¹ä¾†æºé¡å‹ | Q_Last_Valid, Q_Min_Valid, Replacement |
| 10 | `p.type` | `p.source` | Put å ±åƒ¹ä¾†æºé¡å‹ | Q_Last_Valid, Q_Min_Valid, Replacement |
| 11 | `c.time` | - | Call å ±åƒ¹æ™‚é–“ | PRODç¨æœ‰ |
| 12 | `p.time` | - | Put å ±åƒ¹æ™‚é–“ | PRODç¨æœ‰ |
| 13 | `c.sysID` | - | Call ç³»çµ±åºè™Ÿ | PRODç¨æœ‰ |
| 14 | `p.sysID` | - | Put ç³»çµ±åºè™Ÿ | PRODç¨æœ‰ |

### ğŸ“ Q_Last_Valid æ¬„ä½ (æœ€è¿‘æœ‰æ•ˆå ±åƒ¹)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ | é©—è­‰çµæœ |
|---|-----------|-----------|------|---------|
| 15 | `c.last_bid` | `c.last_bid` | Call Q_Last è²·åƒ¹ | âœ… æœ‰é©—è­‰ |
| 16 | `c.last_ask` | `c.last_ask` | Call Q_Last è³£åƒ¹ | âœ… æœ‰é©—è­‰ |
| 17 | `c.last_time` | - | Call Q_Last æ™‚é–“ | PRODç¨æœ‰ |
| 18 | `c.last_sysID` | `c.last_sysID` | Call Q_Last ç³»çµ±åºè™Ÿ | âœ… æœ‰æ¯”å° |
| 19 | `c.last_outlier` | `c.last_outlier` | Call Q_Last ç•°å¸¸å€¼æ¨™è¨˜ | âœ… 99.83% |
| 20 | `p.last_bid` | `p.last_bid` | Put Q_Last è²·åƒ¹ | âœ… æœ‰é©—è­‰ |
| 21 | `p.last_ask` | `p.last_ask` | Put Q_Last è³£åƒ¹ | âœ… æœ‰é©—è­‰ |
| 22 | `p.last_time` | - | Put Q_Last æ™‚é–“ | PRODç¨æœ‰ |
| 23 | `p.last_sysID` | `p.last_sysID` | Put Q_Last ç³»çµ±åºè™Ÿ | âœ… æœ‰æ¯”å° |
| 24 | `p.last_outlier` | `p.last_outlier` | Put Q_Last ç•°å¸¸å€¼æ¨™è¨˜ | âœ… 99.83% |

### ğŸ“‰ Q_Min_Valid æ¬„ä½ (15ç§’å…§æœ€å°åƒ¹å·®å ±åƒ¹)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ | é©—è­‰çµæœ |
|---|-----------|-----------|------|---------|
| 25 | `c.min_bid` | `c.min_bid` | Call Q_Min è²·åƒ¹ | âœ… æœ‰é©—è­‰ |
| 26 | `c.min_ask` | `c.min_ask` | Call Q_Min è³£åƒ¹ | âœ… æœ‰é©—è­‰ |
| 27 | `c.min_time` | - | Call Q_Min æ™‚é–“ | PRODç¨æœ‰ |
| 28 | `c.min_sysID` | `c.min_sysID` | Call Q_Min ç³»çµ±åºè™Ÿ | âœ… æœ‰æ¯”å° |
| 29 | `c.min_outlier` | `c.min_outlier` | Call Q_Min ç•°å¸¸å€¼æ¨™è¨˜ | âš ï¸ 3.36% (ç¬¦åˆé æœŸ) |
| 30 | `p.min_bid` | `p.min_bid` | Put Q_Min è²·åƒ¹ | âœ… æœ‰é©—è­‰ |
| 31 | `p.min_ask` | `p.min_ask` | Put Q_Min è³£åƒ¹ | âœ… æœ‰é©—è­‰ |
| 32 | `p.min_time` | - | Put Q_Min æ™‚é–“ | PRODç¨æœ‰ |
| 33 | `p.min_sysID` | `p.min_sysID` | Put Q_Min ç³»çµ±åºè™Ÿ | âœ… æœ‰æ¯”å° |
| 34 | `p.min_outlier` | `p.min_outlier` | Put Q_Min ç•°å¸¸å€¼æ¨™è¨˜ | âš ï¸ 2.25% (ç¬¦åˆé æœŸ) |

### ğŸ“ˆ EMA èˆ‡ Gamma æ¬„ä½

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ | é©—è­‰çµæœ |
|---|-----------|-----------|------|---------|
| 35 | `c.ema` | `c.ema` | **Call EMA** (æŒ‡æ•¸ç§»å‹•å¹³å‡) | âœ… 100.00% |
| 36 | `c.ema_type` | - | Call EMA é¡å‹ | PRODç¨æœ‰ |
| 37 | `p.ema` | `p.ema` | **Put EMA** (æŒ‡æ•¸ç§»å‹•å¹³å‡) | âœ… 100.00% |
| 38 | `p.ema_type` | - | Put EMA é¡å‹ | PRODç¨æœ‰ |
| 39 | `c.gamma` | `c.gamma` | Call Gamma åƒæ•¸ | âš ï¸ æœ‰å·®ç•°(å·²çŸ¥) |
| 40 | `p.gamma` | `p.gamma` | Put Gamma åƒæ•¸ | âš ï¸ æœ‰å·®ç•°(å·²çŸ¥) |

### âš™ï¸ å…¨åŸŸåƒæ•¸ (PROD ç¨æœ‰æ¬„ä½)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ |
|---|-----------|-----------|------|
| 41 | `alpha` | - | EMA å¹³æ»‘ä¿‚æ•¸ (å¸¸æ•¸ 0.95) |
| 42 | `lambda` | - | æœ€å¤§å…è¨±åƒ¹å·® (å¸¸æ•¸ 0.5 æˆ– 15) |

### ğŸ“¸ å¿«ç…§é¡å¤–è³‡è¨Š (PROD ç¨æœ‰æ¬„ä½)

| # | PROD æ¬„ä½ | æˆ‘å€‘çš„æ¬„ä½ | èªªæ˜ |
|---|-----------|-----------|------|
| 43 | `snapshot_call_bid` | - | å¿«ç…§æ™‚ Call è²·åƒ¹ |
| 44 | `snapshot_call_ask` | - | å¿«ç…§æ™‚ Call è³£åƒ¹ |
| 45 | `snapshot_put_bid` | - | å¿«ç…§æ™‚ Put è²·åƒ¹ |
| 46 | `snapshot_put_ask` | - | å¿«ç…§æ™‚ Put è³£åƒ¹ |
| 47 | `snapshot_sysID` | `snapshot_sysID` | å¿«ç…§ç³»çµ±åºè™Ÿ |

---

## ğŸ“Š æ¯”å°çµ±è¨ˆæ‘˜è¦

### âœ… å®Œå…¨ä¸€è‡´çš„æ¬„ä½ (100%)
1. `c.ema`, `p.ema` - EMA è¨ˆç®—
2. `c.bid`, `c.ask` - Call æœ€çµ‚å ±åƒ¹
3. `p.bid`, `p.ask` - Put æœ€çµ‚å ±åƒ¹

### âš ï¸ é«˜åº¦ä¸€è‡´çš„æ¬„ä½ (>99%)
1. `c.last_outlier` - 99.83% (Near), 99.23% (Next)
2. `p.last_outlier` - 99.83% (Near), 99.53% (Next)

### â„¹ï¸ å·²çŸ¥å·®ç•°æ¬„ä½
1. `c.gamma`, `p.gamma` - å› ç¨‹å¼ä½¿ç”¨ä¸åŒåƒæ•¸è¨­å®š
2. `c.min_outlier`, `p.min_outlier` - Min ä½¿ç”¨ç‡ä½,ç¬¦åˆé æœŸ

### ğŸ” PROD ç¨æœ‰æ¬„ä½ (æˆ‘å€‘æœªè¼¸å‡º)
- æ™‚é–“æˆ³è¨˜: `*.time`, `*.last_time`, `*.min_time`
- ç³»çµ±åºè™Ÿ: `c.sysID`, `p.sysID` (æœ€çµ‚å ±åƒ¹çš„)
- EMA é¡å‹: `*.ema_type`
- å…¨åŸŸåƒæ•¸: `alpha`, `lambda`
- å¿«ç…§è³‡è¨Š: `snapshot_call_*`, `snapshot_put_*`

---

## ğŸ¯ é©—è­‰è…³æœ¬é‚è¼¯

`validation/verify_prod_format.py` çš„æ¯”å°æ–¹å¼:

```python
# 1. ç´¢å¼•æ¬„ä½å°é½Š
merged = pd.merge(
    our_df,
    orig_df_valid,
    left_on=['time', 'strike'],      # æˆ‘å€‘: æ•´æ•¸
    right_on=['time_int', 'strike_int'],  # PROD: è½‰æ›å¾Œçš„æ•´æ•¸
    how='inner',
    suffixes=('_ours', '_orig')
)

# 2. æ•¸å€¼æ¯”å° (å®¹è¨±èª¤å·®)
- EMA: å®¹è¨±èª¤å·® 1e-4
- Bid/Ask: å®¹è¨±èª¤å·® 0.1

# 3. Outlier æ¨™è¨˜æ¯”å°
- 'V' = ç•°å¸¸å€¼ (True)
- æ•¸å­— ('1','2','3','4') = éç•°å¸¸å€¼ (False)
- '-' æˆ–ç©ºç™½ = ç„¡è³‡æ–™ (None)
```

---

**ç¸½çµ**: 
- æ ¸å¿ƒæ•¸å€¼æ¬„ä½ (EMA, Q_hat) **100% ä¸€è‡´** âœ…
- ç¨‹å¼è¼¸å‡º 30 å€‹æ¬„ä½,PROD æœ‰ 47 å€‹æ¬„ä½
- PROD å¤šå‡ºçš„æ¬„ä½ä¸»è¦æ˜¯æ™‚é–“æˆ³è¨˜ã€é¡å‹æ¨™è¨˜ã€å…¨åŸŸåƒæ•¸ç­‰è¼”åŠ©è³‡è¨Š
- Gamma åƒæ•¸ç¨‹å¼ä½¿ç”¨ 1.5/2.0,èˆ‡ PROD æ›´æ¥è¿‘,è€Œé spec.md çš„ 2.0/2.5
