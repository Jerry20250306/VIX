# VIX 演算法邏輯與參數規格書

本文件整合了「選擇權序列價格篩選機制」與「委託簿重建」的核心邏輯，為系統開發與維護的唯一真理來源 (Single Source of Truth)。

## 1. 核心參數設定

依據 Cboe MSCI VIX 編製方法與台灣期貨交易所規範，本系統採用以下參數：

| 參數名稱 | 符號 | 設定值 | 說明 |
| :--- | :---: | :---: | :--- |
| **Smoothing Factor** | $\alpha$ | **0.95** | EMA 平滑係數 (權重分配: 0.95 當期, 0.05 歷史) |
| **Base Gamma** | $\gamma_0$ | **1.20** | 買價為 0 時的基礎寬容度係數 |
| **Bid Improvement Gamma** | $\gamma_1$ | **1.50** | 中價下降或不變時的寬容度係數 (PROD 實際值) |
| **Ask Improvement Gamma** | $\gamma_2$ | **2.00** | 中價上升時的寬容度係數 (PROD 實際值) |
| **Max Spread** | $\lambda$ | **15.0** | 最大允許價差點數 (PROD 實際值) |
| **Filter Window** | $W$ | **15秒** | 有效報價的搜尋回溯區間 |

> **注意**: 參數 $\gamma_1, \gamma_2, \lambda$ 已調整為符合 PROD 環境的實際設定，而非早期文件中的理論值。

---

## 2. 報價資料結構

系統處理的每一筆報價 (Quote) 包含以下資訊：

*   **Time**: 報價時間 (如 08:45:15)
*   **Bid**: 最佳買價
*   **Ask**: 最佳賣價
*   **Expiry**: 到期月份 (Near-Term 或 Next-Term)
*   **Strike**: 履約價
*   **Type**: 買權 (Call) 或 賣權 (Put)

並維護以下狀態變數：
*   **EMA_t**: 當下的價差指數移動平均 (Exponential Moving Average)
*   **Q_hat_t**: 篩選後決定的「最終報價」

---

## 3. 委託簿重建與報價獲取 (Step 1)

在進行 VIX 計算前，必須先從原始逐筆行情 (Tick Data) 重建出每個時間點的「快照 (Snapshot)」。

### 3.1 有效報價定義 (Validity)
一筆報價 $Q$ 必須滿足以下所有條件才視為**有效**：
1.  Bid 與 Ask 皆非 Null
2.  Bid $\ge$ 0
3.  Ask > Bid

### 3.2 報價選擇機制 (Method 2: Min Spread)
對於每個快照時間點 $t$，系統會在 **$[t-15s, t]$** 的區間內搜尋候選報價：

#### A. 最近有效報價 (Q_Last_Valid)
*   定義：$t$ 時點前那一瞬間的最新有效報價。
*   用途：作為主要的價格參考基準。
*   PROD 行為：若 PROD 檔案中有補齊的空值 (Null)，則此值為 Null，視為非異常值。

#### B. 最小價差有效報價 (Q_Min_Valid)
*   定義：在 15 秒區間內，價差 (Spread = Ask - Bid) **最小** 的有效報價。
*   平局決勝 (Tie-breaker)：若有多筆報價價差相同，則選取**時間最晚 (SysID 最大)** 的那一筆。
*   用途：用於更新 EMA，以及當 Q_Last 被判定為異常時的備選方案。

---

## 4. 異常值偵測演算法 (Step 2)

針對 $Q_{Last}$ 與 $Q_{Min}$ 獨立進行異常值判定。

### 4.1 EMA 計算
使用 $Q_{Min}$ 的價差來更新系統的波動率基準：

$$
EMA_t = (1 - \alpha) \times EMA_{t-1} + \alpha \times Spread(Q_{Min\_Valid})
$$

*   若 $EMA_{t-1}$不存在 (首筆)，則 $EMA_t = Spread(Q_{Min\_Valid})$
*   若當前無有效 $Q_{Min}$，則 $EMA_t$ 維持不變。

### 4.2 Gamma 係數判定
依據「上一期最終報價的中價 ($Mid(\hat{Q}_{t-1})$)」與「當前報價」的關係決定 $\gamma$：

| 情況 | 適用 Gamma | 數值 |
| :--- | :---: | :---: |
| 當期 Bid = 0 | $\gamma_0$ | 1.2 |
| 當期 Bid > 0 且 當期 Mid $\le$ 上期 Mid | $\gamma_1$ | 1.5 |
| 當期 Bid > 0 且 當期 Mid > 上期 Mid | $\gamma_2$ | 2.0 |

### 4.3 異常判定條件 (Outlier Conditions)
若報價滿足以下 **任一** 條件，視為**正常 (Not Outlier)**；反之則為**異常 (Outlier)**：

1.  **價差檢核**: $Spread_t \le \gamma \times EMA_t$
2.  **絕對價差檢核**: $Spread_t < \lambda$ (即價差 < 15 點)
3.  **買價合理性**: $Bid_t > Mid(\hat{Q}_{t-1})$ (買價追高，通常視為訊號而非雜訊)
4.  **賣價合理性**: $Ask_t < Mid(\hat{Q}_{t-1})$ 且 $Bid_t > 0$ (賣價殺低，通常視為訊號)

> **特殊規則**: 若報價本身為 Null，或 $EMA_{t-1}$ 尚未建立，則直接視為**正常**。

---

## 5. 最終報價決定 (Step 3)

系統依據以下優先順序決定 $t$ 時刻的最終報價 $\hat{Q}_t$：

1.  **優先使用 Q_Last**:
    *   若 $Q_{Last}$ 存在 且 **非異常值** $\rightarrow$ 使用 $Q_{Last}$

2.  **次要使用 Q_Min**:
    *   若不符合 1，但 $Q_{Min}$ 存在 且 **非異常值** $\rightarrow$ 使用 $Q_{Min}$

3.  **沿用前值 (Replacement)**:
    *   若上述皆不符合 $\rightarrow$ 使用上一期的最終報價 $\hat{Q}_{t-1}$

---

## 6. 輸出結果

演算法最終輸出三個關鍵數值供 VIX 公式計算：
*   **Filtered Bid** ($\hat{Q}_{Bid}$)
*   **Filtered Ask** ($\hat{Q}_{Ask}$)
*   **Filtered Mid** ($\hat{Q}_{Mid}$)
