# VIX 驗證規則與欄位對照規格書

本文件定義 VIX 計算結果的驗證標準，包含與 PROD (生產環境) 資料的欄位對照邏輯。

## 1. 資料來源對照

| 類型 | 系統 (我們的程式) | PROD (標準答案) | 說明 |
| :--- | :--- | :--- | :--- |
| **近月 (Near Term)** | `step0_full_output_Near_全天.csv` | `NearPROD_YYYYMMDD.tsv` | 近月選擇權序列 |
| **次近月 (Next Term)** | `step0_full_output_Next_全天.csv` | `NextPROD_YYYYMMDD.tsv` | 次近月選擇權序列 |

---

## 2. 欄位對照表 (Field Mapping)

PROD 檔案將 Call 與 Put 合併在同一列 (前綴 `c.` 與 `p.`)，而系統輸出為獨立列 (欄位 `CP` 區分)。

### 2.1 索引欄位 (Index)

| PROD 欄位 | 系統欄位 | 轉換與比對規則 |
| :--- | :--- | :--- |
| `time` | `Time` | PROD 為字串 (如 "084530")，系統為數值 (84530)，需去前導零比對。 |
| `strike` | `Strike` | 數值完全相等。 |
| `snapshot_sysID` | `Snapshot_SysID` | 數值完全相等。 |

### 2.2 核心數據欄位 (Data Fields)

以下以 Call (`c.`) 為例，Put (`p.`) 邏輯相同。

| 驗證項目 | PROD 欄位 | 系統欄位 | 備註 |
| :--- | :--- | :--- | :--- |
| **最終買價** | `c.bid` | `Q_hat_Bid` | **🔴 最重要**：影響 VIX 最終結果 |
| **最終賣價** | `c.ask` | `Q_hat_Ask` | **🔴 最重要**：影響 VIX 最終結果 |
| **EMA** | `c.ema` | `EMA` | 允許誤差 < 1e-4 |
| **Gamma** | `c.gamma` | `Q_Last_Valid_Gamma` | 僅供參考 (見已知差異) |
| Q_Last 買價 | `c.last_bid` | `Q_Last_Valid_Bid` | |
| Q_Last 賣價 | `c.last_ask` | `Q_Last_Valid_Ask` | |
| Q_Last 序號 | `c.last_sysID` | `Q_last_SysID` | 需完全一致 |
| Q_Last 異常 | `c.last_outlier` | `Q_Last_Valid_Is_Outlier` | 需轉換 (見下方規則) |
| Q_Min 買價 | `c.min_bid` | `Q_Min_Valid_Bid` | |
| Q_Min 賣價 | `c.min_ask` | `Q_Min_Valid_Ask` | |
| Q_Min 異常 | `c.min_outlier` | `Q_Min_Valid_Is_Outlier` | 需轉換 (見下方規則) |

---

## 3. 數值比對邏輯

### 3.1 異常值標記轉換 (Outlier Flag)
PROD 使用字串標記異常狀態，系統使用布林值 (Boolean)。

| PROD 值 | 意義 | 對應系統值 (Is_Outlier) |
| :--- | :--- | :--- |
| `"V"` | Violation (異常) | `True` |
| `"1"`, `"2"`, `"1,2"` | 通過的條件編號 (正常) | `False` |
| `"-"` 或 空白 | 無資料 | `None` / `False` |

### 3.2 誤差容許範圍
1.  **價格 (Bid/Ask)**: 必須完全相等 (整數)。
2.  **EMA**: 允許浮點數誤差 $< 10^{-4}$。
3.  **Gamma**: 允許誤差 $< 0.01$。

---

## 4. 已知差異 (Known Discrepancies)

### 4.1 Gamma 參數差異
PROD 環境對於 Gamma 的選取邏輯與原始規格略有出入：
*   **中價下跌時**: PROD 使用 1.5 (系統已調整一致)。
*   **中價上漲時**: PROD 使用 2.0 (系統已調整一致)。
*   **首筆資料**: PROD 第一筆從 `08:45:15` 開始計算 EMA，系統從 `08:45:00` 開始，可能導致首筆 Gamma 判定不同。

**結論**: 驗證時若發現 Gamma 不一致，只要最終報價 (`c.bid`, `c.ask`) 正確，可視為可接受的誤差。

### 4.2 報價選擇邏輯
PROD 實際邏輯為：
1.  優先用 Q_Last (若正常)。
2.  次要用 Q_Min (若正常)。
3.  最後用 Replacement (沿用前值)。

系統已完全實作此邏輯，統計上 96.8% 的情況使用 Q_Last。
