# VIX Step 0 計算驗證規格文件

## 文件目的
本文件定義 VIX 計算 Step 0（序列價格篩選）的驗證規則，讓任何人都能依照相同規則比對我們的計算結果與 PROD（生產環境）資料，確保計算邏輯正確。

---

## 1. 資料來源

### 1.1 PROD 資料檔案（標準答案）
| 檔案 | 路徑 | 說明 |
|------|------|------|
| Near Term PROD | `資料來源/20251231/NearPROD_20251231.tsv` | 近月選擇權的生產計算結果 |
| Next Term PROD | `資料來源/20251231/NextPROD_20251231.tsv` | 次近月選擇權的生產計算結果 |

### 1.2 我們的計算程式
| 程式 | 說明 |
|------|------|
| `step0_valid_quotes.py` | Step 0 步驟一：獲取有效報價 |
| `step0_2_ema_calculation.py` | Step 0 步驟二、三：EMA 計算、異常值判定、決定最終報價 |

### 1.3 計算結果輸出
| 檔案 | 說明 |
|------|------|
| `step0_full_output_Near_全天.csv` | Near Term 全天計算結果 |
| `step0_full_output_Next_全天.csv` | Next Term 全天計算結果 |

---

## 2. PROD 資料結構

### 2.1 檔案格式
- **格式**：TSV（Tab-Separated Values）
- **編碼**：UTF-8
- **每列**：一個 `(時間點, 履約價)` 組合，同時包含 Call 和 Put 資訊

### 2.2 索引欄位
| PROD 欄位 | 類型 | 說明 | 範例 |
|-----------|------|------|------|
| `time` | 字串 | 快照時間 (HHMMSS) | "084530" |
| `strike` | 字串 | 履約價 | "28900" |
| `snapshot_sysID` | 字串 | 快照對應的系統序號 | "87592" |

### 2.3 Call 選項欄位（前綴 `c.`）

#### 2.3.1 最終報價欄位
| PROD 欄位 | 說明 | 重要性 |
|-----------|------|--------|
| `c.bid` | **最終篩選後報價的買價**（Q_hat_Bid） | ⭐ 最高 |
| `c.ask` | **最終篩選後報價的賣價**（Q_hat_Ask） | ⭐ 最高 |

#### 2.3.2 Q_Last（最近有效報價）欄位
| PROD 欄位 | 說明 |
|-----------|------|
| `c.last_bid` | Q_Last 的買價 |
| `c.last_ask` | Q_Last 的賣價 |
| `c.last_sysID` | Q_Last 的系統序號 |
| `c.last_outlier` | Q_Last 的異常值標記 |

#### 2.3.3 Q_Min（15秒內最小價差報價）欄位
| PROD 欄位 | 說明 |
|-----------|------|
| `c.min_bid` | Q_Min 的買價 |
| `c.min_ask` | Q_Min 的賣價 |
| `c.min_sysID` | Q_Min 的系統序號 |
| `c.min_outlier` | Q_Min 的異常值標記 |

#### 2.3.4 計算參數欄位
| PROD 欄位 | 說明 |
|-----------|------|
| `c.ema` | **指數移動平均值** |
| `c.gamma` | Gamma 參數（用於判斷 Q_Last） |

### 2.4 Put 選項欄位（前綴 `p.`）
與 Call 相同結構，將 `c.` 替換為 `p.`。

---

## 3. 我們的計算結果結構

### 3.1 索引欄位
| 欄位 | 類型 | 說明 |
|------|------|------|
| `Term` | 字串 | "Near" 或 "Next" |
| `Time` | 整數 | 快照時間（數值格式，如 84530） |
| `Strike` | 整數 | 履約價 |
| `CP` | 字串 | "Call" 或 "Put" |

### 3.2 Q_Last_Valid 欄位
| 欄位 | 說明 |
|------|------|
| `Q_Last_Valid_Bid` | 最近有效報價的買價 |
| `Q_Last_Valid_Ask` | 最近有效報價的賣價 |
| `Q_Last_Valid_Spread` | 價差 |
| `Q_Last_Valid_Mid` | 中價 |
| `Q_Last_Valid_Gamma` | Gamma 參數 |
| `Q_Last_Valid_Is_Outlier` | 是否為異常值 (True/False) |

### 3.3 Q_Min_Valid 欄位
| 欄位 | 說明 |
|------|------|
| `Q_Min_Valid_Bid` | 最小價差報價的買價 |
| `Q_Min_Valid_Ask` | 最小價差報價的賣價 |
| `Q_Min_Valid_Spread` | 價差 |
| `Q_Min_Valid_Mid` | 中價 |
| `Q_Min_Valid_Gamma` | Gamma 參數 |
| `Q_Min_Valid_Is_Outlier` | 是否為異常值 (True/False) |

### 3.4 EMA 欄位
| 欄位 | 說明 |
|------|------|
| `EMA` | 指數移動平均值 |
| `EMA_Process` | EMA 計算過程說明（除錯用） |

### 3.5 Q_hat 最終報價欄位
| 欄位 | 說明 |
|------|------|
| `Q_hat_Bid` | **最終篩選後報價的買價** |
| `Q_hat_Ask` | **最終篩選後報價的賣價** |
| `Q_hat_Mid` | 最終報價的中價 |
| `Q_hat_Source` | 報價來源："Q_Last_Valid"、"Q_Min_Valid"、"Replacement" |

---

## 4. 欄位對照規則

### 4.1 索引對齊
```
PROD:  time='084530', strike='28900'
我們:  Time=84530, Strike=28900, CP='Call' 或 'Put'
```

**轉換規則**：
- PROD `time` (字串) → 我們 `Time` (整數)：去掉前導零
- PROD 一列 = 我們兩列（Call + Put 分開）

### 4.2 Call 欄位對照表

| 驗證項目 | PROD 欄位 | 我們的欄位 | 條件 |
|----------|-----------|------------|------|
| EMA | `c.ema` | `EMA` | CP='Call' |
| Gamma | `c.gamma` | `Q_Last_Valid_Gamma` | CP='Call' |
| Q_Last 買價 | `c.last_bid` | `Q_Last_Valid_Bid` | CP='Call' |
| Q_Last 賣價 | `c.last_ask` | `Q_Last_Valid_Ask` | CP='Call' |
| Q_Last 異常值 | `c.last_outlier` | `Q_Last_Valid_Is_Outlier` | CP='Call' |
| Q_Min 買價 | `c.min_bid` | `Q_Min_Valid_Bid` | CP='Call' |
| Q_Min 賣價 | `c.min_ask` | `Q_Min_Valid_Ask` | CP='Call' |
| Q_Min 異常值 | `c.min_outlier` | `Q_Min_Valid_Is_Outlier` | CP='Call' |
| **最終買價** | `c.bid` | `Q_hat_Bid` | CP='Call' |
| **最終賣價** | `c.ask` | `Q_hat_Ask` | CP='Call' |

### 4.3 Put 欄位對照表
同上，將 `c.` 替換為 `p.`，條件改為 `CP='Put'`。

---

## 5. 數值比對規則

### 5.1 EMA 比對
```python
# 允許浮點數誤差
def ema_match(prod_ema, our_ema):
    if prod_ema is None or our_ema is None:
        return prod_ema is None and our_ema is None
    return abs(float(prod_ema) - float(our_ema)) < 1e-4
```

**EMA 計算公式**（已驗證正確）：
```
EMA_t = 0.95 × EMA_t-1 + 0.05 × Q_Min_Valid_Spread_t
```

### 5.2 異常值標記轉換
```python
# PROD 異常值標記轉換為布林值
def convert_outlier(prod_value):
    if prod_value == 'V':
        return True  # 是異常值
    elif prod_value == '-' or prod_value == '' or pd.isna(prod_value):
        return None  # 無資料
    else:
        return False  # 數字表示通過的條件，非異常值
```

| PROD 值 | 含義 | 我們對應值 |
|---------|------|-----------|
| `V` | 是異常值 | `True` |
| `1`, `2`, `3`, `4`, `5` | 非異常值（數字=通過的條件） | `False` |
| `1,2`, `2,4` 等 | 非異常值（多條件通過） | `False` |
| `-` 或空白 | 無資料 | N/A |

### 5.3 報價比對
```python
# 整數報價完全相等
def quote_match(prod_quote, our_quote):
    if pd.isna(prod_quote) and pd.isna(our_quote):
        return True
    try:
        return int(float(prod_quote)) == int(float(our_quote))
    except:
        return False
```

### 5.4 Gamma 比對
```python
# Gamma 數值比對
def gamma_match(prod_gamma, our_gamma):
    try:
        return abs(float(prod_gamma) - float(our_gamma)) < 0.01
    except:
        return False
```

**注意**：Gamma 值 PROD 與 spec.md 設定不同，預期會有差異。

---

## 6. PROD 報價選擇邏輯

經驗證，PROD 的報價選擇邏輯為：

### 6.1 優先順序
```
優先順序 1：若 Q_Last 非異常值 → 使用 Q_Last
優先順序 2：若 Q_Last 異常值，但 Q_Min 非異常值 → 使用 Q_Min
優先順序 3：若 Q_Last 和 Q_Min 都是異常值 → 使用 Replacement（前值）
```

### 6.2 驗證統計（PROD 全天資料）
| 情況 | 筆數 | 比例 |
|------|------|------|
| 使用 Q_Last | 126,619 | 96.8% |
| 使用 Q_Min | 1,453 | 1.1% |
| 使用 Replacement | 2,728 | 2.1% |

### 6.3 Gamma 使用方式
- PROD 只有一個 `c.gamma`（沒有分 last/min）
- 這個 gamma 是**用於判斷 Q_Last** 的值
- 如果 Q_Last 異常需要檢查 Q_Min 時，會重新計算 Q_Min 的 gamma

---

## 7. 驗證流程

### 7.1 前置準備
1. 確認 PROD 資料檔案存在
2. 確認原始 Tick 資料存在於 `資料來源/J002-11300041_20251231/temp/`
3. 安裝必要 Python 套件：`pandas`, `numpy`

### 7.2 執行計算
```bash
# 步驟一：產生有效報價（修改 max_time_points 為 None 處理全天）
python step0_valid_quotes.py

# 步驟二：EMA 計算與異常值判定
python step0_2_ema_calculation.py
```

### 7.3 執行驗證
```bash
python verify_full_day.py
```

### 7.4 驗證報告解讀
- **正確率 > 99%**：計算邏輯正確
- **正確率 < 99%**：需要分析差異原因
- **已知差異**：Gamma 值（spec.md vs PROD 設定不同）

---

## 8. 驗證優先順序

| 優先順序 | 驗證項目 | 重要性 | 說明 |
|----------|----------|--------|------|
| 1 | **Q_hat (最終報價)** | ⭐⭐⭐ | 直接影響 VIX 最終計算結果 |
| 2 | **EMA** | ⭐⭐⭐ | 影響異常值判定 |
| 3 | **Outlier 標記** | ⭐⭐ | 決定使用哪個報價 |
| 4 | Q_Last_Valid / Q_Min_Valid | ⭐⭐ | 中間計算步驟 |
| 5 | Gamma | ⭐ | 已知與 PROD 有差異 |

---

## 9. 已知差異

### 9.1 Gamma 參數差異
| 情況 | PROD 實際 | spec.md 設定 | 我們的實作 |
|------|-----------|--------------|------------|
| 中價下跌 | 1.5 | 2.0 | 2.0 (γ₁) |
| 中價上漲 | 2.0 | 2.5 | 2.5 (γ₂) |
| Bid = 0 | (無) | 1.2 | 1.2 (γ₀) |

**決策**：保留 spec.md 設定，不追求與 PROD 完全一致。

### 9.2 第一筆判定差異
- PROD 第一筆資料從 084515 開始（084500 無輸出）
- 我們從 084500 開始計算
- 可能導致 084515 的 Gamma 判定差異

---

## 10. 快速驗證指令

### 10.1 驗證單一時間點
```python
import pandas as pd

time_str = '084530'
strike = 28900
cp = 'Call'

# PROD
prod = pd.read_csv('資料來源/20251231/NearPROD_20251231.tsv', sep='\t', dtype=str)
prod_row = prod[(prod['time']==time_str) & (prod['strike']==str(strike))].iloc[0]

# 我們
calc = pd.read_csv('step0_full_output_Near_全天.csv')
calc_row = calc[(calc['Time']==int(time_str)) & (calc['Strike']==strike) & (calc['CP']==cp)].iloc[0]

# 比對
print(f"EMA:  PROD={prod_row['c.ema']}, 我們={calc_row['EMA']}")
print(f"Q_hat: PROD=({prod_row['c.bid']}, {prod_row['c.ask']}), 我們=({calc_row['Q_hat_Bid']}, {calc_row['Q_hat_Ask']})")
```

### 10.2 全天驗證
```bash
python verify_full_day.py
```

---

## 11. 更新紀錄

| 日期 | 修改人 | 內容 |
|------|--------|------|
| 2026-02-08 | - | 初版建立 |
| 2026-02-08 | - | 修正 EMA 公式（歷史權重 95%） |
| 2026-02-08 | - | 新增 PROD 報價選擇邏輯分析 |
| 2026-02-08 | - | 新增 Gamma 使用方式說明 |
